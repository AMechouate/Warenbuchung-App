# Änderungen vom 13.11.2025

## Überblick
- Alle offenen Anforderungen für `Erfassungstyp Bestellung` und `Erfassungstyp Projekt (Baustelle)` umgesetzt.
- Backend um Zuordnungen ohne Buchungshistorie erweitert, Material-Bestand in Seeds vereinheitlicht und Migrationen eingespielt.
- Frontend aktualisiert, damit zugewiesene Artikel ohne Historie sichtbar bleiben, korrekt sortiert werden und mit passenden Einheiten erscheinen.
- Login/Backend-Verbindung stabilisiert und Backend mehrfach neu gestartet, um Änderungen zu testen.

## Backend

- **Modelle & Navigation**
  - Neue Entitäten `OrderAssignedItem` und `ProjectAssignedItem` eingeführt (`Models/OrderAssignedItem.cs`, `Models/ProjectAssignedItem.cs`).
  - Navigationseigenschaften in `Order` und `Product` ergänzt, damit EF die Zuordnungen auflösen kann.

- **DbContext & Seeds** (`Data/WarenbuchungDbContext.cs`)
  - `DbSet`s für die neuen Entitäten registriert und Beziehungen + Indizes konfiguriert.
  - Produkt-Seeds überarbeitet: alle Artikel sind jetzt „Materialien“, Geräte wurden entfernt.
  - Für jede Bestellung 3 zugewiesene Artikel (Defaultmenge 0) hinterlegt.
  - Für jedes Projekt mindestens 3 zugewiesene Materialien bei Menge 0 hinterlegt (Migration `AddProjectAssignmentsSeedUpdate`).
  - Migrationsfolge erstellt und angewendet:
    - `AddOrderAndProjectAssignments`
    - `RemoveHistoryForAssignedItems`
    - `UpdateMaterialsSeed`
    - `ClearWareneingaenge`
    - `AddAdditionalOrderAssignments`
    - `AddProjectAssignmentsSeedUpdate`

- **Controller**
  - `OrdersController`: Endpunkte für `OrderAssignedItems` ergänzt (`GET/POST/PUT/DELETE`), `GetOrders` liefert `AssignedItemCount`.
  - `ProjectAssignmentsController`: Neuer Controller für Projekt-Zuordnungen (`api/projects/{projectKey}/items`).
  - `ItemHistoryScreen`-Backend-Anpassung: Nach Löschen des letzten History-Eintrags wird zurück navigiert.

- **Operationen**
  - Mehrfacher `dotnet ef database update`, inkl. Auflösen des Migration-Locks (`sqlite3 ... DELETE FROM __EFMigrationsLock;`).
  - Backend mit `dotnet run` (Foreground & Background) neu gestartet, um die Änderungen verfügbar zu machen.

## Frontend (React Native / Expo)

- **Konfiguration & Auth**
  - `config.ts`: Entwicklungs-URL auf aktuelle Backend-IP (192.168.8.131) gesetzt.
  - `LoginScreen.tsx`: Verbindungsstatus „Backend Status“ repariert.

- **Navigation & App-Shell** (`App.tsx`)
  - App-Shell auf React Navigation + React Native Paper umgestellt.
  - Login-, Register-, Main-, Profile-, ProjectMaterials-, ItemHistory-Screens integriert.
  - Splash-/Loading-Logik mit SecureStore-basiertem Auto-Login implementiert.

- **Services & Typen**
  - `types/index.ts`: `OrderSummary`, `OrderAssignment`, `ProjectAssignment` ergänzt.
  - `services/api.ts`: Axios-Service mit Order-/Project-Assignment-Endpunkten und Normalisierung.
  - `database.ts`: SQLite-Service (Produkte, Wareneingaenge, Warenausgaenge, Sync-Queue).

- **WareneingaengeScreen.tsx**
  - Toolbar bei Bestellung immer sichtbar, sobald Bestellung gewählt oder Referenz eingetippt wurde.
  - Body:
    - „+ Artikel hinzufügen“-Button & Leerstaat „Keine Artikel hinzugefügt…“ entfernt.
    - `X Artikel buchen` entfernt, stattdessen Speichern-Icon in Kartenköpfen.
    - Neu gespeicherte Artikel erscheinen am Listenende, Mengen starten bei 0, Button ist deaktiviert bis Menge > 0.
    - Zugeordnete Artikel werden aus Produktliste herausgefiltert.
    - Einheitendarstellung über `toDisplayUnit` / `getUnitLabel` korrigiert (z. B. „Sack“ statt „Stück“).
    - Artikel ohne Historie bleiben sichtbar (Merge von Wareneingängen + `*Assignment`s).
  - Historie „Letzte Bestellung“:
    - Zeigt nur aktuelle Bestellung, ohne „Gesamt gebucht“, mit „Letzte Änderung“ + Uhrzeit, Chip höher.
    - „Anzahl Artikel“ unter „Letzte Änderung“, Drei-Punkte-Menü entfernt.
  - Historie „Letztes Projekt“:
    - Analog zu Bestellung nur aktuelles Projekt.
    - Zuweisungen ohne Historie integriert, Menge = 0.
    - Zugeordnete Artikel löschen vorbereitet (X-Button in Karten-Headern).
  - Projekt-Ansicht:
    - Lieferanten-Feld ausgeblendet, Referenzfeld bereinigt, Artikel-/Historien-Layout dem Bestellungstyp angeglichen.
    - `loadProjectAssignments` und `loadProjectMaterials` kombinieren Historie + Zuordnungen.

- **Weitere Screens**
  - `ItemHistoryScreen.tsx`: Nach Löschen des letzten Eintrags automatische Navigation zurück.

- **Stil & Komponenten**
  - Karten, Chips, Buttons überarbeitet (React Native Paper).
  - History-, Materials- und Toolbar-Styles konsolidiert.

## Infrastruktur & Tools

- `package.json` / `package-lock.json`: Expo-, Navigation-, Camera-, SecureStore-, SQLite-, Paper-, Icons-Abhängigkeiten hinzugefügt/aktualisiert.
- `app.json`: App-Namen, Bundle IDs, Splash-Farbe (#0072BC), Camera-Plugin, Cleartext Traffic, EAS-Profile definiert.
- `eas.json`: Build- und Submit-Profile für Entwicklung/Preview/Production angelegt.
- `backend` mehrfach mit `pkill -f WarenbuchungApi` gestoppt, danach `dotnet run` (Background).
- Datenbank-Checks via `sqlite3 warenbuchung.db`.

## Offene Punkte / Nacharbeiten
- Für Artikel-Karten bestehen Löschen-Buttons (`X`), Backend-Entfernen-Endpunkte sind vorhanden; UI-Logik für tatsächliches Entfernen kann noch ergänzt werden.
- Automatisierte Tests fehlen: manueller UI-Test empfohlen (App öffnen, Bestellung/Projekt auswählen, Artikel hinzufügen/speichern).

---
*Datei erstellt am 13.11.2025, basierend auf der gemeinsamen Arbeitssitzung.* 









